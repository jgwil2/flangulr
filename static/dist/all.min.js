var flangulr=angular.module("flangulr",["ui.router","authModule","flashModule","homeModule","loginModule","registerModule"]),authModule=angular.module("authModule",[]),flashModule=angular.module("flashModule",[]),homeModule=angular.module("homeModule",[]),loginModule=angular.module("loginModule",[]),registerModule=angular.module("registerModule",[]);flangulr.config(["$stateProvider","$urlRouterProvider","$locationProvider",function(e,t,r){r.html5Mode(!0),e.state("home",{url:"/",templateUrl:"home.html",controller:"HomeCtrl"}).state("edit",{url:"/edit/:entryId",templateUrl:"edit.html",controller:"HomeCtrl"}).state("login",{url:"/login",templateUrl:"login.html",controller:"LoginCtrl"}).state("register",{url:"/register",templateUrl:"register.html",controller:"RegisterCtrl"}),t.otherwise("/")}]),flangulr.run(["$rootScope","AuthService","$location","FlashService","$state",function(e,t,r,n,o){e.$state=o,e.flash=n;var s=["/","/login","/register"];e.logout=function(){t.logout().success(function(){r.path("/login")})},e.$on("$locationChangeStart",function(){e.user=t.getCurrentUser(),s.indexOf(r.path())<0&&!t.getCurrentUser()&&r.path("/login")})}]),authModule.factory("AuthService",["SessionService","$http","FlashService","CacheService",function(e,t,r){var n=function(t){e.set("user",t)},o=function(){e.unset("user")};return{login:function(e){var o=t.post("/auth/login",e);return o.success(function(e){n(e.user)}),o.error(function(e){r.showMessage(e.message)}),o},logout:function(){var e=t.get("/auth/logout");return e.success(function(e){o(),r.setMessage(e.message)}),e},getCurrentUser:function(){return e.get("user")}}}]),authModule.factory("SessionService",[function(){return{get:function(e){return localStorage.getItem(e)},set:function(e,t){return localStorage.setItem(e,t)},unset:function(e){return localStorage.removeItem(e)}}}]),flashModule.factory("FlashService",["$rootScope",function(e){var t=[],r="";return e.$on("$locationChangeSuccess",function(){r=t.shift()||""}),{setMessage:function(e){t.push(e)},showMessage:function(e){r=e},getMessage:function(){return r}}}]),homeModule.factory("CacheService",["$cacheFactory",function(e){return e("customData")}]),homeModule.factory("DataService",["$http","CacheService","$q","AuthService","FlashService",function(e,t,r,n,o){var s=(n.getCurrentUser(),function(e){t.put("entries",e)}),u=function(e){var r=t.get("entries");r.unshift(e),t.put("entries",r)},i=function(e,r){for(var n=t.get("entries"),o=0,s=n.length;s>o;o++)n[o].id==e&&(n[o]=r);t.put("entries",n)},a=function(e){for(var r=t.get("entries"),n=0,o=r.length;o>n;n++)r[n].id==e&&r.splice(n,1);t.put("entries",r)};return{getEntries:function(){if(t.get("entries"))return r.when(t.get("entries"));var n=e.get("/api/posts").then(function(e){return s(e.data.entries),e.data.entries});return n},addEntry:function(t){var r=e.post("/api/posts",t);return r.success(function(e){u(e.entry),o.showMessage(e.message)}),r.error(function(e){o.showMessage(e.message)}),r},updateEntry:function(t,r){var n=e.put("/api/posts/"+t,r);return n.success(function(e){i(t,r),o.setMessage(e.message)}),n.error(function(e){o.showMessage(e.message)}),n},deleteEntry:function(t){var r=e.delete("/api/posts/"+t);return r.success(function(e){a(t),o.setMessage(e.message)}),r.error(function(e){o.showMessage(e.message)}),r}}}]),homeModule.controller("HomeCtrl",["$scope","$location","DataService","$stateParams",function(e,t,r,n){e.entries={},e.entry={},r.getEntries().then(function(t){if(e.entries=t,t)for(var r=0,o=t.length;o>r;r++)if(t[r].id===parseInt(n.entryId)){e.entry=t[r];break}}),e.addEntry=function(){r.addEntry(e.entry).success(function(){e.entry={}})},e.updateEntry=function(){r.updateEntry(e.entry.id,e.entry).success(function(){t.path("/")})},e.deleteEntry=function(){r.deleteEntry(e.entry.id).success(function(){t.path("/")})}}]),loginModule.controller("LoginCtrl",["$scope","AuthService","$location",function(e,t,r){e.credentials={},e.login=function(){t.login(e.credentials).success(function(){r.path("/")})}}]),registerModule.controller("RegisterCtrl",["$scope","RegisterService","$location",function(e,t,r){e.credentials={},e.register=function(){t.registerUser(e.credentials).success(function(){r.path("/login")})}}]),registerModule.factory("RegisterService",["$http","FlashService",function(e,t){return{registerUser:function(r){var n=e.post("/api/users",r);return n.success(function(e){t.setMessage(e.message)}),n.error(function(e){t.showMessage(e.message)}),n}}}]);